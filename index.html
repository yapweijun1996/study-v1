<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vocabulary Card Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --header-h: 64px;
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f7f7f9;
      color: #222;
      line-height: 1.5;
      padding-top: var(--header-h);
    }
    .header {
      position: fixed;
      top: 0; left: 0; width: 100%; height: var(--header-h);
      background: #3852e2;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-xl);
      font-size: 1.3rem;
      letter-spacing: 1px;
      z-index: 1000;
      transition: transform 0.35s ease;
    }
    .header.hide {
      transform: translateY(-100%);
    }
    .btn-gear {
      background: none; border: none; color: inherit;
      font-size: 1.5rem; cursor: pointer;
      padding: var(--space-sm);
    }
    .settings-panel {
      position: fixed;
      top: var(--header-h); right: 0;
      width: 100%; max-width: 360px;
      background: #fff;
      box-shadow: 0 8px 24px #0003;
      padding: var(--space-md);
      transform: translateY(-150%);
      transition: transform 0.35s ease;
      z-index: 999;
    }
    .settings-panel.open {
      transform: translateY(0);
    }
    .lang-select {
      display: flex;
      gap: var(--space-md);
      align-items: center;
      flex-wrap: wrap;
    }
    .container {
      max-width: 480px;
      margin: var(--space-xl) auto;
      padding: 0 1rem;
    }
    .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: var(--space-md);
    }
    .card {
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 4px 16px #0001;
      padding: var(--space-md) var(--space-md) var(--space-sm) var(--space-md);
      transition: box-shadow 0.2s;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      position: relative;
      border: 2px solid transparent;
    }
    .card:hover, .card:focus {
      box-shadow: 0 8px 24px #3852e244;
      border: 2px solid #3852e2;
      background: #f6f8ff;
      transform: scale(1.02);
      transition: transform 0.15s;
    }
    .card-chevron {
      position: absolute;
      right: 1.2rem;
      top: 1.2rem;
      font-size: 1.3rem;
      color: #3852e2;
      pointer-events: none;
    }
    .word-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.2rem;
      font-weight: 500;
    }
    .pronounce-btn {
      background: #e4eafd;
      border: none;
      border-radius: 50%;
      width: 32px; height: 32px;
      display: flex;
      align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      margin-left: 0.3rem;
    }
    .expand-btn {
      background: #3852e2;
      color: #fff;
      border: none;
      border-radius: 1.5rem;
      padding: 0.2rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      align-self: flex-start;
      margin-top: 0.4rem;
    }
    /* Modal */
    .modal-bg {
      position: fixed;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(56, 82, 226, 0.17);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal {
      background: #f8fafd;
      border-radius: 1.5rem;
      box-shadow: 0 8px 40px #3852e266;
      max-width: 95vw;
      width: 340px;
      max-height: 88vh;
      overflow-y: auto;
      padding: var(--space-xl) var(--space-lg) var(--space-md) var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      animation: modalIn 0.25s cubic-bezier(.36,.76,.6,1.21);
    }
    @keyframes modalIn {
      from { transform: translateY(32px) scale(0.97); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .modal .close-btn {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: #3852e2;
      align-self: flex-end;
      cursor: pointer;
      margin-top: -0.6rem;
      margin-bottom: -0.6rem;
    }
    .modal label {
      font-weight: 500;
      margin-bottom: 0.25rem;
      display: inline-block;
    }
    .modal input, .modal textarea {
      width: 100%;
      font-size: 1.04rem;
      border-radius: 0.7rem;
      border: 1px solid #b5bfff;
      padding: 0.6rem 0.9rem;
      margin-top: 0.2rem;
      background: #f6f8ff;
      resize: none;
      box-sizing: border-box;
    }
    input, textarea {
      box-sizing: border-box;
    }
    .modal .ai-reply {
      margin-top: 0.5rem;
      padding: 0.8rem 1rem;
      border-radius: 1rem;
      background: #f0f4fe;
      font-size: 1.02rem;
    }
    .modal .send-btn {
      background: #3852e2;
      color: #fff;
      border: none;
      border-radius: 1.2rem;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.5rem;
      align-self: flex-end;
    }
    @media (max-width: 600px) {
      .container { margin: 1rem 0; }
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 0.8rem;
        padding: 0.7rem 0.5rem;
        font-size: 1.08rem;
      }
      .lang-select {
        flex-direction: column;
        align-items: stretch;
        gap: 0.7rem;
      }
      .lang-select label,
      .lang-select select {
        width: 100%;
        max-width: 100%;
      }
    }
    /* Very small phones */
    @media (max-width: 375px) {
      html { font-size: 90%; }
      .header { padding: var(--space-sm) var(--space-sm); }
      .ai-toolbar { padding: 0 var(--space-sm); }
    }
    /* Tablets: two-column cards */
    @media (min-width: 768px) {
      .container { max-width: 720px; }
      .card-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-md);
      }
    }
    /* Desktops: three-column cards */
    @media (min-width: 1024px) {
      .container { max-width: 960px; }
      .card-list {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .chat-history { margin-bottom: 1rem; max-height: 180px; overflow-y: auto; }
    .chat-msg { margin-bottom: 0.5rem; padding: 0.5rem 0.8rem; border-radius: 0.7rem; }
    .user-msg { background: #e4eafd; text-align: right; }
    .ai-msg { background: #f0f4fe; text-align: left; }
    .dot {
      display: inline-block; width: 8px; height: 8px; margin: 0 2px;
      background: #3852e2; border-radius: 50%; opacity: 0.6;
      animation: bounce 1s infinite alternate;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      from { transform: translateY(0);}
      to { transform: translateY(-8px);}
    }
    .loader {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 180px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e4eafd;
      border-top: 4px solid #3852e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .ai-toolbar {
      max-width: 480px;
      margin: 1.2rem auto 0 auto;
      padding: 0 1rem;
    }
    .loader-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .ai-toolbar > div {
      padding: var(--space-md) var(--space-lg);
    }
    .difficulty-chip {
      position: absolute;
      top: var(--space-xs);
      right: var(--space-xs);
      font-size: 0.8rem;
    }
    .pinyin { font-style: italic; color: #666; }
    /* Loader spinner */
    .loader {
      width: 3rem; height: 3rem;
      border: .5rem solid #d2d6ff;
      border-top-color: #3852e2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: var(--space-lg) auto;
    }
    .hidden { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
  <script src="script_top.js"></script><!--- apiKey at here -->
</head>
<body>
  <header class="header">
    <span>AI Vocabulary Cards</span>
    <div class="lang-select">
      <label for="lang1">From:</label>
      <select id="lang1">
        <option value="en">English</option>
        <option value="zh">中文</option>
      </select>
      <span>→</span>
      <label for="lang2">To:</label>
      <select id="lang2">
        <option value="zh">中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>
  <section class="ai-toolbar" aria-label="AI Controls">
    <div style="background:#fff;border-radius:1rem;box-shadow:0 2px 12px #0001;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
      <label for="modelSelect">Model:</label>
      <select id="modelSelect">
        <option value="gemini-2.0-flash">gemini-2.0-flash</option>
        <option value="gemma-3-27b-it">gemma-3-27b-it</option>
      </select>
      <label for="voiceSelect">Voice:</label>
      <select id="voiceSelect"></select>
      <label for="levelSelect">Level:</label>
      <select id="levelSelect">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
  </div>
  </section>
  <main class="container">
    <section class="card-list" id="cardList"></section>
    <div id="loader" class="loader hidden" aria-hidden="true"></div>
    <div id="sentinel"></div>
  </main>

  <!-- Modal (hidden by default) -->
  <div class="modal-bg" id="modalBg" style="display:none;">
    <div class="modal" id="modalContent">
      <!-- Dynamic modal content inserted by JS -->
    </div>
  </div>

  <script>
    // Demo vocabulary list, easily expandable!
    let vocabData = [
      {
        en: 'Apple',
        zh: '苹果',
        en_pron: 'ˈæp.əl',
        zh_pron: 'píng guǒ',
        en_def: 'A round fruit with red, green, or yellow skin and firm white flesh.',
        zh_def: '一种圆形的水果，有红色、绿色或黄色的表皮，果肉坚实。',
        en_example: 'She ate an apple for breakfast.',
        zh_example: '她早餐吃了一个苹果。'
      },
      {
        en: 'Computer',
        zh: '电脑',
        en_pron: 'kəmˈpjuː.tər',
        zh_pron: 'diàn nǎo',
        en_def: 'An electronic device for storing and processing data.',
        zh_def: '一种用于存储和处理数据的电子设备。',
        en_example: 'My computer is very fast.',
        zh_example: '我的电脑很快。'
      },
      {
        en: 'Train',
        zh: '火车',
        en_pron: 'treɪn',
        zh_pron: 'huǒ chē',
        en_def: 'A series of connected vehicles that travel along a railway.',
        zh_def: '一种沿铁轨行驶的连接车辆。',
        en_example: 'We took a train to Beijing.',
        zh_example: '我们坐火车去了北京。'
      },
      {
        en: 'Teacher',
        zh: '老师',
        en_pron: 'ˈtiː.tʃər',
        zh_pron: 'lǎo shī',
        en_def: 'A person who helps students learn in school.',
        zh_def: '在学校帮助学生学习的人。',
        en_example: 'My English teacher is very friendly.',
        zh_example: '我的英语老师非常友好。'
      }
      // ... Add more as needed
    ];

    // State
    let fromLang = localStorage.getItem('fromLang') || 'en';
    let toLang = localStorage.getItem('toLang') || 'zh';
    let selectedModel = localStorage.getItem('geminiModel') || 'gemini-2.0-flash';
    let selectedLevel = localStorage.getItem('selectedLevel') || 'easy';
    let chatHistory = {};

    // Elements
    const cardList = document.getElementById('cardList');
    const lang1 = document.getElementById('lang1');
    const lang2 = document.getElementById('lang2');
    const modalBg = document.getElementById('modalBg');
    const modalContent = document.getElementById('modalContent');
    const modelSelect = document.getElementById('modelSelect');

    // Initialize model and API key input
    modelSelect.value = selectedModel;
    lang1.value = fromLang;
    lang2.value = toLang;

    modelSelect.onchange = () => {
      selectedModel = modelSelect.value;
      localStorage.setItem('geminiModel', selectedModel);
    };

    // Gemini API config
    const generationConfig = {
      temperature: 1,
      topP: 0.95,
      topK: 40,
      maxOutputTokens: 8192,
      responseMimeType: "text/plain"
    };

    // Start chat session for the selected model
    async function startChatSession(selectedModel, wordKey) {
      return {
        sendMessage: async function(messageData) {
          let userMessage = typeof messageData === "string"
            ? { role: "user", parts: [{ text: messageData }] }
            : messageData;
          // Use per-word chat history
          if (!chatHistory[wordKey]) chatHistory[wordKey] = [];
          const requestBody = {
            contents: [...chatHistory[wordKey], userMessage],
            generationConfig
          };
          const url = "https://generativelanguage.googleapis.com/v1beta/models/" + selectedModel +
            ":generateContent?key=" + apiKey;
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestBody)
          });
          if (!response.ok)
            throw new Error("API error " + response.status);
          const result = await response.json();
          if (result.candidates && result.candidates.length > 0) {
            const modelResponse = {
              role: "model",
              parts: result.candidates[0].content.parts
            };
            chatHistory[wordKey].push(userMessage, modelResponse);
          } else {
            throw new Error("No response from API");
          }
          return result;
        }
      };
    }

    // Lazy load state
    let cardsToShow = 10;
    const CARDS_BATCH_SIZE = 10;
    function renderCards(reset = false) {
      if (reset) cardsToShow = CARDS_BATCH_SIZE;
      cardList.innerHTML = '';
      // Only show cards if two different languages selected
      if (fromLang === toLang) {
        cardList.innerHTML = '<div style="padding:2rem;text-align:center;color:#888;">Please select different languages.</div>';
        return;
      }
      const toRender = vocabData.slice(0, cardsToShow);
      toRender.forEach((word, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.tabIndex = 0;
        // Pronunciation
        const pronWord = fromLang === 'en' ? word.en : word.zh;
        const pronLang = fromLang === 'en' ? 'en-US' : 'zh-CN';
        const levelColor = selectedLevel==='easy'?'🟢':(selectedLevel==='medium'?'🟠':'🔴');
        card.innerHTML = `
          <div class="word-row">
            <span>${word[fromLang]}</span>
            <button class="pronounce-btn" data-word="${pronWord}" data-lang="${pronLang}" title="Pronounce">
              🔊
            </button>
          </div>
          <div style="font-size:1rem;color:#3852e2;">
            ${word[toLang]}
          </div>
          <div style="font-size:0.98rem;color:#444;display:flex;align-items:center;gap:0.5rem;">
            <b>Example:</b> ${word[fromLang + '_example']}
            <button class="tts-btn" data-sentence="${word[fromLang + '_example'].replace(/"/g, '&quot;')}" data-lang="${fromLang === 'en' ? 'en-US' : 'zh-CN'}" title="Read example" style="background:#e4eafd;border:none;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;">🔊</button>
            <button class="save-btn" title="Save word" style="background:none;border:none;font-size:1.1rem;cursor:pointer;">★</button>
          </div>
          <span class="card-chevron">&#8594;</span>
          <span class="difficulty-chip">${levelColor}</span>
        `;
        // Pronunciation button
        card.querySelector('.pronounce-btn').onclick = (e) => {
          e.stopPropagation();
          speakWord(pronWord, pronLang);
        };
        // TTS for example sentence
        card.querySelector('.tts-btn').onclick = (e) => {
          e.stopPropagation();
          speakWord(e.currentTarget.dataset.sentence, e.currentTarget.dataset.lang);
        };
        card.querySelector('.save-btn').onclick = (e)=>{e.stopPropagation(); alert('Saved!');};
        card.onclick = () => openModal(word, idx);
        card.tabIndex = 0;
        cardList.appendChild(card);
      });
      // If more cards to load, add a sentinel div for scroll detection
      if (cardsToShow < vocabData.length) {
        let sentinel = document.createElement('div');
        sentinel.id = 'cardSentinel';
        sentinel.style.height = '32px';
        cardList.appendChild(sentinel);
      }
    }

    // Infinite scroll logic
    function onCardListScroll() {
      const sentinel = document.getElementById('cardSentinel');
      if (!sentinel) return;
      const rect = sentinel.getBoundingClientRect();
      if (rect.top < window.innerHeight + 100) {
        // Load more cards
        if (cardsToShow < vocabData.length) {
          cardsToShow += CARDS_BATCH_SIZE;
          renderCards();
        }
      }
    }
    cardList.addEventListener('scroll', onCardListScroll);
    window.addEventListener('scroll', onCardListScroll); // for mobile/viewport scrolling

    // Build a language->voices map
    const voiceMap = {}; // { en:[voices], zh:[voices] }
    function loadVoices() {
      voiceMap.en = voiceMap.zh = voiceMap.ms = [];
      speechSynthesis.getVoices().forEach(v => {
        const key = v.lang.split('-')[0];
        (voiceMap[key] ??= []).push(v);
      });
    }
    loadVoices();
    speechSynthesis.onvoiceschanged = () => { loadVoices(); populateVoiceList(); };

    // Language detection (simple)
    function detectLang(text) {
      // Chinese detection
      if (/[一-龥]/.test(text)) return 'zh';
      // Default to English
      return 'en';
    }

    document.getElementById('voiceSelect').addEventListener('change', e => {
      localStorage.setItem('selectedVoice', e.target.value);
    });

    function pickVoice(langCode) {
      const prefix = langCode.split('-')[0];
      const list = voiceMap[prefix] || [];
      return list.find(v => v.localService) || list[0] || speechSynthesis.getVoices()[0];
    }

    function speakWord(text, explicitLang = null) {
      // Strip parenthesized content (e.g. pinyin) before speaking
      const clean = text.replace(/[（(][^）)]+[）)]/g, '').trim();
      if (!window.speechSynthesis) return;
      const langCode = explicitLang || detectLang(clean);
      const utter = new SpeechSynthesisUtterance(clean);
      utter.lang = langCode;
      utter.rate = 0.95;
      utter.pitch = 1.0;
      const savedName = localStorage.getItem('selectedVoice');
      if (savedName) {
        const savedV = speechSynthesis.getVoices().find(v => v.name === savedName);
        if (savedV) utter.voice = savedV;
      } else {
        utter.voice = pickVoice(langCode);
      }
      speechSynthesis.speak(utter);
    }

    // Populate voiceSelect dropdown
    function populateVoiceList() {
      const voiceSelect = document.getElementById('voiceSelect');
      if (!voiceSelect) return;
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = '';
      voices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})${v.default ? ' — Default' : ''}`;
        voiceSelect.appendChild(opt);
      });
      const saved = localStorage.getItem('selectedVoice');
      if (saved) voiceSelect.value = saved;
    }

    // Function to load more examples for a word
    async function loadMoreExamples(word) {
      const wordKey = word.en + '|examples';
      const btn = modalContent.querySelector('.load-examples-btn');
      const examplesDiv = modalContent.querySelector('#examplesSection');
      btn.disabled = true;
      btn.textContent = 'Loading...';
      // Compose prompt for 3 more examples
      const prompt = `Generate 3 additional example sentences using the word "${word.en}" (Chinese: ${word.zh}). Provide English and Chinese versions for each, and format as a JSON array of objects with keys en_example and zh_example.`;
      try {
        const session = await startChatSession(selectedModel, wordKey);
        const result = await session.sendMessage(prompt);
        let text = '';
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
          text = result.candidates[0].content.parts.map(p => p.text).join('\n');
        }
        // Extract JSON
        const start = text.indexOf('[');
        const end = text.lastIndexOf(']');
        if (start === -1 || end === -1) throw new Error('No JSON found');
        const jsonStr = text.substring(start, end + 1);
        const data = JSON.parse(jsonStr);
        data.forEach(item => {
          // English example
          const enDiv = document.createElement('div');
          enDiv.style.cssText = 'font-size:0.98rem;color:#444;display:flex;align-items:center;gap:0.5rem;margin-top:0.5rem;';
          enDiv.innerHTML = `${item.en_example} <button class="tts-btn" data-sentence="${item.en_example.replace(/"/g,'&quot;')}" data-lang="en-US" title="Read example">🔊</button>`;
          examplesDiv.appendChild(enDiv);
          // Chinese example
          const zhDiv = document.createElement('div');
          zhDiv.style.cssText = 'font-size:0.98rem;color:#3852e2;display:flex;align-items:center;gap:0.5rem;';
          zhDiv.innerHTML = `${item.zh_example} <button class="tts-btn" data-sentence="${item.zh_example.replace(/"/g,'&quot;')}" data-lang="zh-CN" title="Read example">🔊</button>`;
          examplesDiv.appendChild(zhDiv);
        });
        // Attach tts handlers for new buttons
        examplesDiv.querySelectorAll('.tts-btn').forEach(btn => {
          btn.onclick = () => speakWord(btn.dataset.sentence, btn.dataset.lang);
        });
        btn.disabled = false;
        btn.textContent = 'Load More Examples';
      } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Load More Examples';
        console.error(err);
        alert('Error loading more examples: ' + err.message);
      }
    }

    function openModal(word, idx) {
      // Prepare separated examples and pinyin
      const fromExample = word[fromLang + '_example'];
      const toExample = word[toLang + '_example'];
      // Generate from-language TTS button
      const ttsFrom = `<button class="tts-btn" data-sentence="${fromExample.replace(/"/g,'&quot;')}" data-lang="${fromLang==='en'?'en-US':'zh-CN'}" title="Read example">🔊</button>`;
      // Extract pinyin if present in parentheses
      const pinyinMatch = toExample.match(/[（(]([^）)]+)[）)]/);
      const toText = toExample.replace(/[（(][^）)]+[）)]/g, '').trim();
      const ttsTo = `<button class="tts-btn" data-sentence="${toText.replace(/"/g,'&quot;')}" data-lang="${toLang==='en'?'en-US':'zh-CN'}" title="Read example">🔊</button>`;
      const pinyinHtml = pinyinMatch ? `<div class="pinyin">（${pinyinMatch[1]}）</div>` : '';
      const examplesHtml = `
        <div id="examplesSection">
          <b>Example:</b><br>
          ${fromExample}${ttsFrom}<br>
          ${toText}${ttsTo}
          ${pinyinHtml}
        </div>`;
      // Pronunciation buttons in modal
      let pronBtnEN = `<button class="pronounce-btn" data-word="${word.en}" data-lang="en-US" title="Pronounce">🔊</button>`;
      let pronBtnZH = `<button class="pronounce-btn" data-word="${word.zh}" data-lang="zh-CN" title="Pronounce">🔊</button>`;
      // Unique key for chat history
      const wordKey = word.en + '|' + word.zh;
      // Render chat history for this word
      let chatHtml = '';
      if (chatHistory[wordKey] && chatHistory[wordKey].length > 0) {
        chatHtml = '<div class="chat-history">' + chatHistory[wordKey].map(msg => {
          if (msg.role === 'user') {
            return `<div class="chat-msg user-msg"><b>You:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
          } else if (msg.role === 'model') {
            return `<div class="chat-msg ai-msg"><b>AI:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
          } else {
            return '';
          }
        }).join('') + '</div>';
      }
      modalContent.innerHTML = `
        <button class="close-btn" title="Close">&times;</button>
        <div style="font-size:1.28rem;font-weight:600;margin-bottom:var(--space-xs);">
          ${word.en} ${pronBtnEN} / ${word.zh} ${pronBtnZH}
        </div>
        <div style="font-size:1rem;color:#888;margin-bottom:var(--space-sm);">
          [${word.en_pron}] / [${word.zh_pron}]
        </div>
        <div style="margin-bottom:var(--space-sm);">
          <b>Definition:</b><br>
          <span>${word[fromLang + '_def']}</span>
          <br><span style="color:#3852e2;">${word[toLang + '_def']}</span>
        </div>
        ${examplesHtml}
        <button class="load-examples-btn" style="margin-top:var(--space-sm);">Load More Examples</button>
        <hr style="margin:var(--space-sm) 0 var(--space-xs) 0;">
        ${chatHtml}
        <label for="askAiInput">Ask AI about this word</label>
        <input id="askAiInput" placeholder="Type your question..." autocomplete="off" />
        <button class="send-btn" id="sendBtn">Send</button>
        <div class="ai-reply" id="aiReply" style="display:none;"></div>
      `;
      // Close button
      modalContent.querySelector('.close-btn').onclick = closeModal;
      // Pronunciation buttons in modal
      modalContent.querySelectorAll('.pronounce-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          speakWord(btn.dataset.word, btn.dataset.lang);
        };
      });
      // TTS for existing examples
      modalContent.querySelectorAll('#examplesSection .tts-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          speakWord(btn.dataset.sentence, btn.dataset.lang);
        };
      });
      // Load more examples button
      modalContent.querySelector('.load-examples-btn').onclick = () => loadMoreExamples(word);
      // Ask AI
        const input = modalContent.querySelector('#askAiInput');
      const sendBtn = modalContent.querySelector('#sendBtn');
      sendBtn.addEventListener('click', () => {
        const question = input.value.trim();
        askAiAboutWord(word, question);
        input.value = '';
        input.focus();
      });
      // Allow Enter key to send AI message
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendBtn.click();
        }
      });
      modalBg.style.display = '';
      setTimeout(() => modalContent.querySelector('#askAiInput').focus(), 250);
    }

    // Helper to re-render chat history in modal after new message
    function updateChatHistoryInModal(word) {
      const wordKey = word.en + '|' + word.zh;
      const chatDiv = modalContent.querySelector('.chat-history');
      if (!chatDiv) return;
      if (chatHistory[wordKey] && chatHistory[wordKey].length > 0) {
        chatDiv.innerHTML = chatHistory[wordKey].map(msg => {
          if (msg.role === 'user') {
            return `<div class="chat-msg user-msg"><b>You:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
          } else if (msg.role === 'model') {
            return `<div class="chat-msg ai-msg"><b>AI:</b> ${msg.parts.map(p => p.text).join('')}</div>`;
          } else {
            return '';
          }
        }).join('');
      } else {
        chatDiv.innerHTML = '';
      }
    }

    function closeModal() {
      modalBg.style.display = 'none';
    }

    function askAiAboutWord(word, question) {
      const replyDiv = modalContent.querySelector('#aiReply');
      if (!question.trim()) {
        replyDiv.style.display = '';
        replyDiv.textContent = "Please enter a question!";
        return;
      }
      if (!apiKey) {
        replyDiv.style.display = '';
        replyDiv.textContent = "Please enter your Gemini API key above.";
        return;
      }
      replyDiv.style.display = '';
      replyDiv.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      // Compose prompt
      const prompt = `You are an AI language tutor. The user is asking about the word "${word.en}" (Chinese: ${word.zh}). Provide a helpful, clear answer.\n\nWord details:\n- English: ${word.en}\n- Chinese: ${word.zh}\n- English definition: ${word.en_def}\n- Chinese definition: ${word.zh_def}\n- English example: ${word.en_example}\n- Chinese example: ${word.zh_example}\n\nUser question: ${question}`;
      // Use a unique key for the word (en+zh)
      const wordKey = word.en + '|' + word.zh;
      // Call Gemini API with per-word chat history
      startChatSession(selectedModel, wordKey).then(session => {
        return session.sendMessage(prompt);
      }).then(result => {
        let reply = '';
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
          reply = result.candidates[0].content.parts.map(p => p.text).join('\n');
        } else {
          reply = "Sorry, no response from Gemini.";
        }
        replyDiv.textContent = reply;
        // Update chat history display in modal
        updateChatHistoryInModal(word);
      }).catch(err => {
        replyDiv.textContent = "Error: " + (err.message || err);
      });
    }

    // Language pickers
    lang1.onchange = () => {
      fromLang = lang1.value;
      toLang = lang2.value;
      // Prevent same selection
      if (fromLang === toLang) {
        toLang = fromLang === 'en' ? 'zh' : 'en';
        lang2.value = toLang;
      }
      localStorage.setItem('fromLang', fromLang);
      localStorage.setItem('toLang', toLang);
      renderCards(true);
    };
    lang2.onchange = () => {
      toLang = lang2.value;
      fromLang = lang1.value;
      // Prevent same selection
      if (fromLang === toLang) {
        fromLang = toLang === 'en' ? 'zh' : 'en';
        lang1.value = fromLang;
      }
      localStorage.setItem('fromLang', fromLang);
      localStorage.setItem('toLang', toLang);
      renderCards(true);
    };
    // Modal close on background click
    modalBg.onclick = (e) => { if (e.target === modalBg) closeModal(); };

    // --- Auto-generate vocabData using Gemini AI on load ---
    async function generateVocabDataWithAI() {
      // Show full-screen loader overlay
      let loaderBg = document.getElementById('loaderBg');
      if (!loaderBg) {
        loaderBg = document.createElement('div');
        loaderBg.id = 'loaderBg';
        loaderBg.className = 'loader-bg';
        loaderBg.innerHTML = '<div class="spinner"></div>';
        document.body.appendChild(loaderBg);
      }
      loaderBg.style.display = 'flex';
      // Compose prompt for Gemini
      const prompt = `Generate a list of 10 English words with their Chinese translations, IPA pronunciations, definitions, and example sentences in both languages. Format as a JSON array with keys: en, zh, en_pron, zh_pron, en_def, zh_def, en_example, zh_example.`;
      try {
        const session = await startChatSession(selectedModel, '__vocabgen__');
        const result = await session.sendMessage(prompt);
        let text = '';
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
          text = result.candidates[0].content.parts.map(p => p.text).join('\n');
        }
        // Try to extract JSON from the response
        let jsonStart = text.indexOf('[');
        let jsonEnd = text.lastIndexOf(']');
        if (jsonStart !== -1 && jsonEnd !== -1) {
          let jsonStr = text.substring(jsonStart, jsonEnd + 1);
          let data = JSON.parse(jsonStr);
          if (Array.isArray(data) && data.length > 0) {
            vocabData = data;
            loaderBg.style.display = 'none';
            renderCards(true);
            return;
          }
        }
        throw new Error('Could not parse vocab list from AI response.');
      } catch (err) {
        loaderBg.style.display = 'none';
        cardList.innerHTML = `<div style=\"padding:2rem;text-align:center;color:#c00;\">Failed to load vocabulary from AI.<br>${err.message || err}</div>`;
      }
    }

    // Initialize: auto-generate vocabData using AI
    generateVocabDataWithAI();

    // Infinite scroll using IntersectionObserver
    (function() {
      let fetching = false;
      const loaderEl = document.getElementById('loader');
      const sentinelEl = document.getElementById('sentinel');
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            if (fetching) return;
            if (cardsToShow >= vocabData.length) {
              observer.disconnect();
              return;
            }
            fetching = true;
            loaderEl.classList.remove('hidden');
            setTimeout(() => {
              cardsToShow += CARDS_BATCH_SIZE;
              renderCards(false);
              loaderEl.classList.add('hidden');
              fetching = false;
            }, 300);
          }
        });
      }, { rootMargin: '200px' });
      observer.observe(sentinelEl);
    })();
  </script>
</body>
</html>
